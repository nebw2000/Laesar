<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Laser Show</title>
<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:black;
  overflow:hidden;
  font-family:sans-serif;
}
#controls{
  position:fixed;
  top:10px;
  left:10px;
  z-index:10;
  color:white;
}
button,input{
  margin-right:6px;
}
#status{
  margin-top:6px;
  font-size:14px;
}
canvas{ display:block; }
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="audiofile" accept="audio/*">
  <button id="toggleBtn">Modus wechseln</button>
  <button id="downloadBtn">Download</button>
  <div id="status">Status: kein Signal</div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

// Audio/Analyser
let audioCtx, analyser, bufferLength, dataArray;
let audioElement=null, sourceNode=null, micStream=null;
let mode = "none"; // "mp3" oder "mic"
let lastAudioSrc = null; // speichert zuletzt geladene MP3

let currentEffect=0, nextEffect=0, effectAlpha=1;
let variant=0, subVariant=0;
let lastBeat=0, beatTimes=[], bpm=120;

const statusEl = document.getElementById("status");

function avg(a){ return a.reduce((x,y)=>x+y,0)/a.length; }
function color(v,i){ return `rgb(${(v*2+i)%255},${(255-v+i)%255},${(v*3-i)%255})`; }

function setupAnalyser(){
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
}

function stopAll(){
  if(audioElement){ audioElement.pause(); audioElement=null; }
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(audioCtx){ audioCtx.close(); audioCtx=null; }
  analyser=null;
  mode="none";
  statusEl.textContent="Status: kein Signal";
}

// MP3-Upload
document.getElementById("audiofile").addEventListener("change", async e=>{
  const file=e.target.files[0];
  if(!file) return;

  stopAll();

  lastAudioSrc = URL.createObjectURL(file); // speichert MP3 für Toggle

  audioCtx=new AudioContext();
  setupAnalyser();

  audioElement=new Audio(lastAudioSrc);
  audioElement.loop=true;
  sourceNode=audioCtx.createMediaElementSource(audioElement);
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);

  audioElement.play();
  mode="mp3";
  statusEl.textContent="Status: MP3 aktiv";
});

// Toggle Button MP3 ↔ Mic
document.getElementById("toggleBtn").onclick=async()=>{
  if(mode==="mp3"){
    // Wechsel zu Mikrofon
    stopAll();
    audioCtx=new AudioContext();
    setupAnalyser();
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    sourceNode=audioCtx.createMediaStreamSource(micStream);
    sourceNode.connect(analyser);
    mode="mic";
    statusEl.textContent="Status: Mikrofon aktiv";
  }
  else if(mode==="mic"){
    // Wechsel zurück zur letzten MP3
    if(!lastAudioSrc){
      statusEl.textContent="Status: keine MP3 geladen";
      return;
    }
    stopAll();
    audioCtx=new AudioContext();
    setupAnalyser();
    audioElement=new Audio(lastAudioSrc);
    audioElement.loop=true;
    sourceNode=audioCtx.createMediaElementSource(audioElement);
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    audioElement.play();
    mode="mp3";
    statusEl.textContent="Status: MP3 aktiv";
  }
  else{
    // Startzustand: MP3 laden
    document.getElementById("audiofile").click();
  }
};

// Beat Detection
function detectBeat(data){
  const bass=data.slice(0,data.length/8);
  const level=avg(bass);
  const now=performance.now();

  if(level>160 && now-lastBeat>150){
    lastBeat=now;
    beatTimes.push(now);
    if(beatTimes.length>8) beatTimes.shift();

    currentEffect=nextEffect;
    nextEffect=Math.floor(Math.random()*6);
    variant=Math.floor(Math.random()*15);
    subVariant=Math.floor(Math.random()*5);
    effectAlpha=0;

    if(beatTimes.length>1){
      const d=[];
      for(let i=1;i<beatTimes.length;i++) d.push(beatTimes[i]-beatTimes[i-1]);
      bpm=60000/avg(d);
    }
  }
}

// Draw Effects
function draw(effect,bass,mids,highs,a){
  ctx.globalAlpha=a;
  const speed=bpm/120;

  if(effect===0){
    const r=avg(bass)*(0.6+variant/30);
    const t=performance.now()/500*speed;
    ctx.beginPath();
    ctx.arc(canvas.width/2+Math.sin(t)*80,canvas.height/2,r,0,Math.PI*2);
    ctx.fillStyle=color(r,variant);
    ctx.fill();
  }
  if(effect===1){
    mids.forEach((v,i)=>{
      ctx.fillStyle=color(v,i+variant);
      ctx.fillRect(i*3,canvas.height/2,2,-v*2);
    });
  }
  if(effect===2){
    for(let i=0;i<highs.length;i+=8){
      const s=highs[i]/4;
      ctx.beginPath();
      ctx.arc(Math.random()*canvas.width,Math.random()*canvas.height,s,0,Math.PI*2);
      ctx.fillStyle=color(s,i);
      ctx.fill();
    }
  }
  if(effect===3){
    ctx.save();
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(performance.now()/800*speed);
    for(let i=0;i<8;i++){
      ctx.rotate(Math.PI/4);
      ctx.strokeStyle=color(avg(bass),i);
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(200+avg(bass),0);
      ctx.stroke();
    }
    ctx.restore();
  }
  if(effect===4){
    const sides=5+subVariant;
    const r=avg(bass);
    ctx.beginPath();
    for(let i=0;i<=sides;i++){
      const a=i*2*Math.PI/sides;
      ctx.lineTo(canvas.width/2+r*Math.cos(a),canvas.height/2+r*Math.sin(a));
    }
    ctx.strokeStyle=color(r,variant);
    ctx.stroke();
  }
  if(effect===5){
    const b=Math.random()*255;
    ctx.fillStyle=`rgb(${b},${b},${b})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  ctx.globalAlpha=1;
}

// Animation Loop
function animate(){
  requestAnimationFrame(animate);
  if(!analyser) return;

  analyser.getByteFrequencyData(dataArray);

  const bass=dataArray.slice(0,bufferLength/8);
  const mids=dataArray.slice(bufferLength/8,bufferLength/2);
  const highs=dataArray.slice(bufferLength/2);

  ctx.fillStyle="rgba(0,0,0,0.2)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  detectBeat(dataArray);
  draw(currentEffect,bass,mids,highs,effectAlpha);
  effectAlpha=Math.min(effectAlpha+0.05,1);
}

// Download Funktion
document.getElementById("downloadBtn").onclick=()=>{
  if(!audioCtx) return;

  const stream=canvas.captureStream(60);
  const tracks=[...stream.getVideoTracks()];
  if(audioElement) tracks.push(...audioElement.captureStream().getAudioTracks());

  const rec=new MediaRecorder(new MediaStream(tracks));
  const chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob(chunks,{type:"video/webm"}));
    a.download="lasershow.webm";
    a.click();
  };
  rec.start();
  setTimeout(()=>rec.stop(),30000);
};

animate();
</script>
</body>
</html>
